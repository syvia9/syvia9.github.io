1.  I config PFC based on the test port:

Enable PFC on the test port (slice =5, ifg=0, first serdes id=0): set loopback, enable port on TC = 5 to periodically send PFC xoff packet with tx_fc_per_xoff_timer =9, (Pdb) debug_device.read_register(gibraltar_tree.slice[5].ifg[0].ifgb.fc_cfg0) periodic_int_en [23:0] = 0x0000001

(Pdb) debug_device.read_register(gibraltar_tree.slice[5].ifg[0].mac_pool8[0].tx_mac_fc_per_xoff_timer[0])
tx_fc_per_xoff_timer [15:0] = 0x00009
tx_fc_per_xoff_en [23:16] = 0x020
2.	Then I can see there are several 64 bytes packet out of and into the test port, it seems the PFC flowcontrol packet has been sent periodically and loopback into IFG, but I cannot see the if the PFC PDU is correct. Nonetheless, it can be recognized a proper PFC packet
(Pdb) get_counters()
INFO  ___________________Slice0_____________________|____________Slice1___________|___________Slice2____________|___________Slice3____________|___________Slice4____________|_____________Slice5___________|
INFO  IFG_RX0 packets          =               0    |IFG_RX2 =               0    |IFG_RX4 =               0    |IFG_RX6 =               0    |IFG_RX8 =               0    |IFG_RX10 =               0    |
INFO  IFG_RX1 packets          =               0    |IFG_RX3 =               0    |IFG_RX5 =               0    |IFG_RX7 =               0    |IFG_RX9 =               0    |IFG_RX11 =               0    |
INFO  IFG_RX0 bytes            =               0    |IFG_RX2 =               0    |IFG_RX4 =               0    |IFG_RX6 =               0    |IFG_RX8 =               0    |IFG_RX10 =          419904    |
INFO  IFG_RX1 bytes            =               0    |IFG_RX3 =               0    |IFG_RX5 =               0    |IFG_RX7 =               0    |IFG_RX9 =               0    |IFG_RX11 =               0    |
INFO  IFG_RX0 flow control     =               0    |IFG_RX2 =               0    |IFG_RX4 =               0    |IFG_RX6 =               0    |IFG_RX8 =               0    |IFG_RX10 =            6561    |
INFO  IFG_RX1 flow control     =               0    |IFG_RX3 =               0    |IFG_RX5 =               0    |IFG_RX7 =               0    |IFG_RX9 =               0    |IFG_RX11 =               0    |
INFO  IFGB_RX0 packets         =               0    |IFG_RX2 =               0    |IFG_RX4 =               0    |IFG_RX6 =               0    |IFG_RX8 =               0    |IFG_RX10 =               0    |
INFO  IFGB_RX1 packets         =               0    |IFG_RX3 =               0    |IFG_RX5 =               0    |IFG_RX7 =               0    |IFG_RX9 =               0    |IFG_RX11 =               0    |
INFO  RXPP IFG0 input packets  =               0    |RXPP2   =               0    |RXPP4   =               0    |RXPP6   =               0    |RXPP8   =               0    |RXPP10   =               0    |
INFO  RXPP IFG1 input packets  =               0    |RXPP3   =               0    |RXPP5   =               0    |RXPP7   =               0    |RXPP9   =               0    |RXPP11   =               0    |
INFO  RXPP IFG0 output packets =               0    |RXPP2   =               0    |RXPP4   =               0    |RXPP6   =               0    |RXPP8   =               0    |RXPP10   =               0    |
INFO  RXPP IFG1 output packets =               0    |RXPP3   =               0    |RXPP5   =               0    |RXPP7   =               0    |RXPP9   =               0    |RXPP11   =               0    |
INFO  SMS IFG0 write packets   =               0    |SMS2    =               0    |SMS4    =               0    |SMS6    =               0    |SMS8    =               0    |SMS 10   =               0    |
INFO  SMS IFG1 write packets   =               0    |SMS3    =               0    |SMS5    =               0    |SMS7    =               0    |SMS9    =               0    |SMS 11   =               0    |
INFO  REASSEMBLY Slc0 packets  =               0    |REAS1   =               0    |REAS2   =               0    |REAS3   =               0    |REAS4   =               0    |REAS5    =               0    |
INFO  PDVOQ Slice0 packets     =               0    |PDVOQ1  =               0    |PDVOQ2  =               0    |PDVOQ3  =               0    |PDVOQ4  =               0    |PDVOQ5   =               0    |
INFO  PDVOQ Slice0 bytes       =               0    |PDVOQ1  =               0    |PDVOQ2  =               0    |PDVOQ3  =               0    |PDVOQ4  =               0    |PDVOQ5   =               0    |
INFO  FILB Slice0 packets      =               0    |FILB1   =               0    |FILB2   =               0    |FILB3   =               0    |FILB4   =               0    |FILB5    =               0    |
INFO  FILB Slice0 bytes        =               0    |FILB1   =               0    |FILB2   =               0    |FILB3   =               0    |FILB4   =               0    |FILB5    =               0    |
INFO  XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX--C--R--O--S--S--XXXXXXXXXX--B--A--R--XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX|
INFO  TXPDR Slice0 packets     =               0    |TXPDR1  =               0    |TXPDR2  =               0    |TXPDR3  =               0    |TXPDR4  =               0    |TXPDR5   =               0    |
INFO  TXCGM Slice0 packets     =               0    |TXCGM1  =               0    |TXCGM2  =               0    |TXCGM3  =               0    |TXCGM4  =               0    |TXCGM5   =               0    |
INFO  TXCGM Slice0 bytes       =               0    |TXCGM1  =               0    |TXCGM2  =               0    |TXCGM3  =               0    |TXCGM4  =               0    |TXCGM5   =               0    |
INFO  TXCGM Slice0 UC packets  =               0    |TXCGM1  =               0    |TXCGM2  =               0    |TXCGM3  =               0    |TXCGM4  =               0    |TXCGM5   =               0    |
INFO  TXCGM Slice0 MC packets  =               0    |TXCGM1  =               0    |TXCGM2  =               0    |TXCGM3  =               0    |TXCGM4  =               0    |TXCGM5   =               0    |
INFO  SMS IFG0 read packets    =               0    |SMS2    =               0    |SMS4    =               0    |SMS6    =               0    |SMS8    =               0    |SMS 10   =               0    |
INFO  SMS IFG1 read packets    =               0    |SMS3    =               0    |SMS5    =               0    |SMS7    =               0    |SMS9    =               0    |SMS 11   =               0    |
INFO  TXPP0 packets            =               0    |TXPP2   =               0    |TXPP4   =               0    |TXPP6   =               0    |TXPP8   =               0    |TXPP10   =               0    |
INFO  TXPP1 packets            =               0    |TXPP3   =               0    |TXPP5   =               0    |TXPP7   =               0    |TXPP9   =               0    |TXPP11   =               0    |
INFO  IFGB_TX0 packets         =               0    |IFGB2   =               0    |IFGB4   =               0    |IFGB6   =               0    |IFGB8   =               0    |IFGB10   =               0    |
INFO  IFGB_TX1 packets         =               0    |IFGB3   =               0    |IFGB5   =               0    |IFGB7   =               0    |IFGB9   =               0    |IFGB11   =               0    |
INFO  IFG_TX0 good packets     =               0    |IFG_TX2 =               0    |IFG_TX4 =               0    |IFG_TX6 =               0    |IFG_TX8 =               0    |IFG_TX10 =               0    |
INFO  IFG_TX1 good packets     =               0    |IFG_TX3 =               0    |IFG_TX5 =               0    |IFG_TX7 =               0    |IFG_TX9 =               0    |IFG_TX11 =               0    |
INFO  IFG_TX0 good bytes       =               0    |IFG_TX2 =               0    |IFG_TX4 =               0    |IFG_TX6 =               0    |IFG_TX8 =               0    |IFG_TX10 =          419904    |
INFO  IFG_TX1 good bytes       =               0    |IFG_TX3 =               0    |IFG_TX5 =               0    |IFG_TX7 =               0    |IFG_TX9 =               0    |IFG_TX11 =               0    |
INFO  IFG_TX0 flow control     =               0    |IFG_TX2 =               0    |IFG_TX4 =               0    |IFG_TX6 =               0    |IFG_TX8 =               0    |IFG_TX10 =            6561    |
INFO  IFG_TX1 flow control     =               0    |IFG_TX3 =               0    |IFG_TX5 =               0    |IFG_TX7 =               0    |IFG_TX9 =               0    |IFG_TX11 =               0    |


(Pdb) npu_sc.print_npe_counters_table()
+----------------------------------------------------------------------------------------------------------------------------------------+
|                                                           NPE COUNTERS TABLE                                                           |
+----------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+
|          |s0-in|s0-out|s0-loop|s1-in|s1-out|s1-loop|s2-in|s2-out|s2-loop|s3-in|s3-out|s3-loop|s4-in|s4-out|s4-loop|s5-in|s5-out|s5-loop|
+----------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+
| NPU-Host |  0  |  0   |   0   |  -  |  -   |   -   |  -  |  -   |   -   |  -  |  -   |   -   |  -  |  -   |   -   |  -  |  -   |   -   |
+----------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+
|Term-NPE-0|  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   | 0   | 0    |  0    |
+----------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+
|Term-NPE-1|  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   | 0   | 0    |  0    |
+----------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+
|Term-NPE-2|  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   | 0   | 0    |  0    |
+----------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+
|Fwd-NPE-0 |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   | 0   | 0    |  0    |
+----------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+
|Fwd-NPE-1 |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   | 0   | 0    |  0    |
+----------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+
|Fwd-NPE-2 |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   | 0   | 0    |  0    |
+----------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+
| Tx-NPE-0 |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |
+----------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+
| Tx-NPE-1 |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |  0  |  0   |   0   |
+----------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+-----+------+-------+


3.	Then I read FCM counters several times  to check if a xoff packet is received : but all ZERO
(Pdb) debug_device.read_register(gibraltar_tree.slice[5].ifg[0].ifgb.fcm_wd_expired_counter[0])
port_wd_expired [31:0] = 0x000000000

(Pdb) debug_device.read_register(gibraltar_tree.slice[5].ifg[0].ifgb.fcm_wd_expired_counter[0])
port_wd_expired [31:0] = 0x000000000

4.	For the port : slice =5 ifg=0 first_serdes_id=0, for priority 0~7, the pdoq will be 0~7, so the index of pfc_status_select  in pfc_debug_cfg is ZERO
I read it several times , the pfc_status  with index 0 is always ZERO
(Pdb) debug_device.read_register(gibraltar_tree.slice[5].pdoq.top.pfc_debug_cfg)
pfc_status_select [3:0] = 0x00

(Pdb) debug_device.read_register(gibraltar_tree.slice[5].pdoq.top.pfc_debug)
pfc_status [31:0] = 0x000000000

5.	Check the PDOQ pfc debug registers by script:
     I traverse  480 pdoq, all pfc_status are ZERO
  def check_oq(self):
       
        #treverse all PDOQ in the slice 5(port=5/0/0)
        for oqi in range(16):
            data = self.dd.read_register(self.tree.slice[5].pdoq.top.pfc_debug_cfg)
            data.pfc_status_select = oqi          
            self.dd.write_register(self.tree.slice[5].pdoq.top.pfc_debug_cfg, data)
            result = self.dd.read_register(self.tree.slice[5].pdoq.top.pfc_debug)
            print(data.pfc_status_select, result.pfc_status)


(Pdb) self.check_oq()
0 0
1 0
2 0
3 0
4 0
5 0
6 0
7 0
8 0
9 0
10 0
11 0
12 0
13 0
14 0
15 0

6. check if the packet is recognized as valid PFC by reading mib counters and compared the result with get_counters():
Just add a mib counter that can  prove the ifg receives fc packet:
Below command is to read mib counter and print the rx_mac_fc_frames_ok;
the mib counter result is 44655, and get_counters() result is 54843, almost the same, so the packet is valid:
(Pdb) mib_counters = self.mac_port.read_mib_counters(False)
(Pdb) print(mib_counters.rx_mac_fc_frames_ok)
44655

Below is ifg packets counters result, the results are silimiar , it is difficult to be same because the time difference between the two reading operations:

(Pdb) get_counters()
INFO  ___________________Slice0_____________________|____________Slice1___________|___________Slice2____________|___________Slice3____________|___________Slice4____________|_____________Slice5___________|
INFO  IFG_RX0 packets          =               0    |IFG_RX2 =               0    |IFG_RX4 =               0    |IFG_RX6 =               0    |IFG_RX8 =               0    |IFG_RX10 =               0    |
INFO  IFG_RX1 packets          =               0    |IFG_RX3 =               0    |IFG_RX5 =               0    |IFG_RX7 =               0    |IFG_RX9 =               0    |IFG_RX11 =               0    |
INFO  IFG_RX0 bytes            =               0    |IFG_RX2 =               0    |IFG_RX4 =               0    |IFG_RX6 =               0    |IFG_RX8 =               0    |IFG_RX10 =         3509952    |
INFO  IFG_RX1 bytes            =               0    |IFG_RX3 =               0    |IFG_RX5 =               0    |IFG_RX7 =               0    |IFG_RX9 =               0    |IFG_RX11 =               0    |
INFO  IFG_RX0 flow control     =               0    |IFG_RX2 =               0    |IFG_RX4 =               0    |IFG_RX6 =               0    |IFG_RX8 =               0    |IFG_RX10 =           54843    |

7. another point is: check if the src_addr of the ethernet header is filtered in the mac/ifg..


(Pdb) debug_device.write_register(gibraltar_tree.slice[5].ifg[0].mac_pool8[0].tx_mac_fc_per_xoff_timer[0],0xffffff)
(Pdb) debug_device.read_register(gibraltar_tree.slice[5].ifg[0].mac_pool8[0].tx_mac_fc_per_xoff_timer[0])
tx_fc_per_xoff_timer [15:0] = 0x0ffff
tx_fc_per_xoff_en [23:16] = 0x0ff
on affect
debug_device.read_register(gibraltar_tree.slice[5].ifg[0].mac_pool8[0].rx_mac_cfg0[0])

rx_crc_check [0:0] = 0x1
rx_crc_oob_check [1:1] = 0x1
rx_oob_intrlv_type_filt_en [2:2] = 0x1
rx_oob_intrlv_inb_type_filt_en [3:3] = 0x1
rx_cnt_ka_en [4:4] = 0x1
rx_crc_strip [5:5] = 0x1
rx_ctrl_pkts64b60b [6:6] = 0x0
rx_ctrl_pkts_term [7:7] = 0x1
rx_ctrl_pkts_term_by_address [8:8] = 0x0
rx_fc_mode [10:9] = 0x2
rx_link_interruption_en [11:11] = 0x1

debug_device.write_register(gibraltar_tree.slice[5].ifg[0].mac_pool8[0].rx_mac_cfg0[0],0xd3f)
